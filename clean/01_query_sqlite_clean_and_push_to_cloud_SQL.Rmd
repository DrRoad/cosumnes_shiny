---
title: "Query SQLite, clean, and push to cloud SQL"
output: html_document
---

The purpose of this script is to:  

* obtain data from the Home Station Database for Level Sender, in `C:/Users/rpauloo/Documents/LevelSender/db/levelsender.sqlite`  
* clean that data (adjusting for barometric pressure)  
* push clean data to cloud SQL database  


First, load the relevant libraries.
```{r}
library(RSQLite)
library(DBI)
library(tidyverse)
library(stringr)
library(lubridate)
```

Refresh emails and append to sqlite database.
```{r}
# simulates clicking the "Retrieve Emails Button"
system(
  shQuote(
    "C:/Program Files (x86)/Solinst/LevelSender/LSEmailClient.exe", 
    type = "cmd" # change to "sh" for Unix/bash, and "csh" for C-shell
  )
)
```


Connect to .sqlite database, and list the tables of data within.
```{r}
# connect to SQLite database that Solinist regularly updates
db <- dbConnect(SQLite(), dbname = "C:/Users/rpauloo/Documents/LevelSender/db/levelsender.sqlite")

# get metadata about level senders
meta <- dbReadTable(db, "LevelSenderSettings")

# read emails, select interesting data, filter for relevant emails with data, and rename columns
d <- dbReadTable(db, "ReceivedEmail") %>% 
  select(ReceivedDate, Subject, Body) %>% 
  filter( grepl("LS Report", Subject) ) %>% 
  rename(date = ReceivedDate, subject = Subject, body = Body)

# We want to arrange these emails by the date they were received, but first we need to convert the `Date` from a character vector to a `Date` object.
d$date <- as.POSIXct( strptime( d$date, "%Y-%m-%d %H:%M:%S" ) )
```


Filter for all emails within a 30 day window of the current date.
```{r}
# 30 day rolling window
current <- Sys.Date() - 30

# add another date column without times
d$date_2 <- as_date(d$date)

# filter for all emails from `current` onwards
check <- filter(d, date_2 >= current)
```


Identify records containing MW5.
```{r}
# serial number for mw5
mw5 <- ": 283687"

# separate each email body into a vector of lines, and store each in a list element
lines <- lapply(check$body, function(x){unlist(strsplit(x, "\r\n"))} )

# function to apply
get_data <- function(v){ 
  
  # initalize baro vector
  baro <- NULL 
  
  # does mw5 appear in the email? 
  ss <- sum(str_detect(v, mw5)) 
  
  # if the well == MW 5
  if (ss == 1) {
    id <- v[str_detect(v, "Serial: ")][2]    # 2nd serial is level logger
    baro <- v[str_detect(v, "Serial: ")][3]  # 3rd serial is baro  logger
  }

  # if the well != mw5
  if (ss == 0) {
    id <- v[str_detect(v, "Serial: ")][2]    # 2nd serial number is level logger
  }

  # subset for the level logger serial number
  id <- as.numeric(substr(id, 9, nchar(id)))
  
  # if barometric pressure logger is present, get its serial
  if(!is.null(baro)){baro <- as.numeric(substr(baro, 9, nchar(baro)))}
  
  # get all datetime, temp, level data
  i <- str_detect(v, "^[:digit:]")           # all lines that begin with a digit
  ld <- v[i]                                 # subset for these lines
  
  # organize into a dataframe
  m <- str_split_fixed(ld, ", ", 3)          # matrix of strings
  m[, 2:3] <- round(as.numeric(m[, 2:3]), 2) # round temp and level
  df <- as.data.frame(m)                     # convert to df
  colnames(df) <- c("dt", "temp", "level")   # rename columns
  df$dt <- dmy_hms(df$dt)                    # format dates
  
  # if the well == MW 5
  if (ss == 1) {
    df$id <- rep(c(id, baro), each = nrow(df)/2) # add ids of ll and baro logger
  }

  # if the well != mw5
  if (ss == 0) {
    df$id <- id # add id of level logger
  }
  
  return(df)
}


v = lines[[1]] # non-MW5
v = lines[[6]]  # MW5

get_data(v)
```

Apply function to all `current` data.
```{r}

```


Convert from PSI to meters
```{r}
# convert from PSI to meters
psi_to_m <- function(psi){
  return(psi * 0.703070)
}
```



Load the current state of the cloud database. Save a version of the database every 7 days
```{r}
# password for gw obs db
pw <- read_rds("C:/Users/rpauloo/Documents/GitHub/cosumnes_shiny/dashboard/data/pw.rds")

# connect to the cloud SQL database 
cdb <- dbConnect(RMySQL::MySQL(),
                 user = "gw_observatory",
                 password = pw,
                 host = "169.237.35.237",
                 dbname = "gw_observatory",
                 port = 33306)

# historical data
hist <- dbReadTable(cdb, "clean_historical_data_through_october")

# fix class of dates and levels
hist$date <- ymd_hms(hist$date)
hist <- hist %>% 
  gather(well, level, -date) %>% 
  mutate(level = as.numeric(level)) %>% 
  spread(well, level)

# days of year to save copy of the data
save_days <- seq(8,365, 7)

# get day of the year
doy <- yday(Sys.Date())

ifelse(doy %in% save_days == TRUE, 
       dbWriteTable(cdb, 
                    name = paste(formatC(which(save_days == doy), width = 2, flag ="0"), 
                                 doy-7, doy, data, sep="_"),
                    value = d),
       print("nothing to report here")
       )
```



